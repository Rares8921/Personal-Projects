<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<script>(function(){document.documentElement.className=localStorage.getItem('theme')||'light'})();</script>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Refrigerator Control</title>
<link rel="stylesheet" th:href="@{/css/style.css}"/>
<link rel="stylesheet" th:href="@{/css/device_control.css}"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous"/>
<script defer src="/script/theme-toggle.js"></script>
</head>
<body class="light">
<div th:replace="~{fragments :: headerFrag}"></div>
<main class="container">
    <h2><i class="fas fa-snowflake"></i> Refrigerator Control</h2>
    <div id="message"></div>
    <div class="status-panel">
        <div class="status-item"><span class="label">ID:</span><span id="devId"></span></div>
        <div class="status-item"><span class="label">Name:</span><span id="devName"></span></div>
        <div class="status-item"><span class="label">Temperature:</span><span id="devTemp"></span></div>
        <div class="status-item"><span class="label">Door:</span><span id="devDoor" class="status-badge"></span></div>
    </div>
    <div class="control-group">
        <label>Temperature (-5 to 10°C):</label>
        <input id="tempInput" type="range" min="-5" max="10" step="0.5" value="4"/>
        <span id="tempVal">4</span>°C
        <button class="primary" onclick="updateTemp()"><i class="fas fa-thermometer-half"></i> Set Temperature</button>
    </div>
    <div class="controls">
        <button class="primary" onclick="toggleDoor()"><i class="fas fa-door-open"></i> Toggle Door</button>
    </div>
    <div class="control-group">
        <label>Inventory:</label>
        <ul id="inventoryItems" style="list-style:none;padding:0;margin:8px 0"></ul>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
            <input id="itemName" type="text" placeholder="Item name" style="flex:1;min-width:120px"/>
            <input id="expiryDate" type="date" style="flex:1;min-width:120px"/>
            <button class="primary" onclick="addItem()"><i class="fas fa-plus"></i> Add Item</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
            <button class="primary" onclick="checkExpired()"><i class="fas fa-clock"></i> Check Expired</button>
            <button class="primary" onclick="removeExpired()" style="background:#ef4444"><i class="fas fa-trash"></i> Remove Expired</button>
        </div>
    </div>
    <button class="secondary" onclick="location.href='/refrigerator_management'"><i class="fas fa-arrow-left"></i> Back</button>
</main>
<div th:replace="~{fragments :: footerFrag}"></div>
<script src="/script/main.js"></script>
<script>
const API="/api/refrigerators",id=new URLSearchParams(location.search).get("id");const token=localStorage.getItem("jwt");
document.getElementById("tempInput").addEventListener("input",e=>document.getElementById("tempVal").textContent=e.target.value);
async function loadDev(){try{const r=await fetch(API+"/"+id,{headers:{"Authorization":"Bearer "+token}});const d=await r.json();document.getElementById("devId").textContent=d.id;document.getElementById("devName").textContent=d.name;document.getElementById("devTemp").textContent=d.temperature+"°C";document.getElementById("devDoor").textContent=d.doorOpen?"Open":"Closed";document.getElementById("devDoor").className="status-badge "+(d.doorOpen?"off":"on");document.getElementById("tempInput").value=d.temperature;document.getElementById("tempVal").textContent=d.temperature;loadInventory()}catch(e){document.getElementById("message").textContent=e.message}}
async function updateTemp(){await fetch(API+"/"+id+"/updateTemperature",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify({temperature:document.getElementById("tempInput").value})});showMsg("Temperature updated");loadDev()}
async function toggleDoor(){await fetch(API+"/"+id+"/toggleDoor",{method:"POST",headers:{"Authorization":"Bearer "+token}});showMsg("Door toggled");loadDev()}
async function loadInventory(){try{const r=await fetch(API+"/"+id+"/items",{headers:{"Authorization":"Bearer "+token}});const items=await r.json();const ul=document.getElementById("inventoryItems");ul.innerHTML="";items.forEach(item=>{ul.innerHTML+=`<li style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(69,192,122,0.1)"><span>${item.name} — expires ${item.expiryDate}</span><button class="primary" onclick="removeItem(${item.id})" style="padding:4px 10px;font-size:0.8rem"><i class="fas fa-trash"></i></button></li>`})}catch(e){}}
async function addItem(){const name=document.getElementById("itemName").value,expiryDate=document.getElementById("expiryDate").value;await fetch(API+"/"+id+"/items",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify({name,expiryDate})});showMsg("Item added");loadInventory()}
async function removeItem(itemId){await fetch(API+"/"+id+"/items/"+itemId,{method:"DELETE",headers:{"Authorization":"Bearer "+token}});loadInventory()}
async function removeExpired(){const r=await fetch(API+"/"+id+"/items/expired",{method:"DELETE",headers:{"Authorization":"Bearer "+token}});showMsg(await r.text());loadInventory()}
async function checkExpired(){const r=await fetch(API+"/"+id+"/checkExpired",{headers:{"Authorization":"Bearer "+token}});showMsg(await r.text())}
function showMsg(m){const el=document.getElementById("message");el.textContent=m;setTimeout(()=>el.textContent="",5000)}
loadDev();
</script>
</body>
</html>
